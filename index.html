<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notícias de Tecnologia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: transparent; padding: 16px; }
        .widget-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #0078d4; }
        .widget-title { font-size: 18px; font-weight: 600; color: #323130; display: flex; align-items: center; gap: 8px; }
        .widget-title svg { width: 24px; height: 24px; fill: #0078d4; }
        .ultima-atualizacao { font-size: 11px; color: #605e5c; }
        .noticias-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .noticia-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; transition: all 0.2s ease; border: 1px solid #edebe9; }
        .noticia-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .noticia-imagem { width: 100%; height: 140px; object-fit: cover; background: linear-gradient(135deg, #0078d4, #00a4ef); }
        .noticia-placeholder { width: 100%; height: 140px; background: linear-gradient(135deg, #0078d4 0%, #00a4ef 50%, #7fba00 100%); display: flex; align-items: center; justify-content: center; }
        .noticia-placeholder svg { width: 48px; height: 48px; fill: rgba(255,255,255,0.9); }
        .noticia-conteudo { padding: 12px; }
        .noticia-fonte { display: inline-block; font-size: 10px; font-weight: 600; color: #fff; padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; text-transform: uppercase; }
        .noticia-titulo { font-size: 14px; font-weight: 600; color: #323130; line-height: 1.4; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .noticia-titulo a { color: inherit; text-decoration: none; }
        .noticia-titulo a:hover { color: #0078d4; }
        .noticia-data { font-size: 11px; color: #605e5c; }
        .loading { text-align: center; padding: 40px; color: #605e5c; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #edebe9; border-top: 3px solid #0078d4; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="widget-header">
        <div class="widget-title">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            Notícias de Tecnologia
        </div>
        <span class="ultima-atualizacao" id="ultima-atualizacao"></span>
    </div>
    <div id="noticias-container" class="noticias-grid">
        <div class="loading"><div class="loading-spinner"></div><p>Carregando notícias...</p></div>
    </div>

    <script>
        // Configuração
        const FEEDS = [
            { nome: "TecMundo", url: "https://rss.tecmundo.com.br/feed", cor: "#e74c3c" },
            { nome: "Olhar Digital", url: "https://olhardigital.com.br/feed/", cor: "#3498db" },
            { nome: "Tecnoblog", url: "https://tecnoblog.net/feed/", cor: "#9b59b6" },
            { nome: "Canaltech", url: "https://canaltech.com.br/rss/", cor: "#2ecc71" }
        ];

        const PROXIES = [
            "https://api.allorigins.win/raw?url=",
            "https://corsproxy.io/?",
            "https://api.codetabs.com/v1/proxy?quest="
        ];

        const PALAVRAS_BLOQUEADAS = [
            "oferta","ofertas","promoção","promoções","desconto","descontos","cupom","cupons",
            "grátis","black friday","cyber monday","amazon","magazine luiza","magalu","mercado livre",
            "aliexpress","shopee","compre agora","comprar","onde comprar","melhor preço","cashback",
            "frete grátis","economize","barato","liquidação","deal","deals","sale","outlet"
        ];

        // Função para tratar erro de imagem - SOLUÇÃO SEM ASPAS PROBLEMÁTICAS
        function handleImageError(img) {
            const placeholder = document.createElement('div');
            placeholder.className = 'noticia-placeholder';
            placeholder.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>';
            img.parentNode.replaceChild(placeholder, img);
        }

        function filtrarPromocao(texto) {
            const textoLower = texto.toLowerCase();
            return PALAVRAS_BLOQUEADAS.some(palavra => textoLower.includes(palavra));
        }

        function formatarData(dataStr) {
            try {
                const data = new Date(dataStr);
                const agora = new Date();
                const diff = Math.floor((agora - data) / 60000);
                if (diff < 1) return "Agora";
                if (diff < 60) return `Há ${diff} min`;
                if (diff < 1440) return `Há ${Math.floor(diff / 60)}h`;
                return "Agora há pouco";
            } catch (e) {
                return "Agora há pouco";
            }
        }

        function extrairImagem(item) {
            try {
                // 1. media:content
                const mediaContent = item.getElementsByTagName("media:content")[0];
                if (mediaContent) {
                    const url = mediaContent.getAttribute("url");
                    if (url && url.startsWith("http")) return url;
                }
                // 2. enclosure
                const enclosure = item.getElementsByTagName("enclosure")[0];
                if (enclosure) {
                    const url = enclosure.getAttribute("url");
                    if (url && url.startsWith("http")) return url;
                }
                // 3. content:encoded
                const contentEncoded = item.getElementsByTagName("content:encoded")[0];
                if (contentEncoded) {
                    const match = contentEncoded.textContent.match(/<img[^>]+src=["']([^"']+)["']/i);
                    if (match && match[1].startsWith("http")) return match[1];
                }
                // 4. description
                const desc = item.getElementsByTagName("description")[0];
                if (desc) {
                    const match = desc.textContent.match(/<img[^>]+src=["']([^"']+)["']/i);
                    if (match && match[1].startsWith("http")) return match[1];
                }
            } catch (e) {}
            return "";
        }

        async function fetchComProxy(url) {
            for (const proxy of PROXIES) {
                try {
                    const resp = await fetch(proxy + encodeURIComponent(url), { 
                        signal: AbortSignal.timeout(8000) 
                    });
                    if (resp.ok) return await resp.text();
                } catch (e) {}
            }
            return null;
        }

        async function carregarNoticias() {
            const container = document.getElementById("noticias-container");
            let todasNoticias = [];

            for (const feed of FEEDS) {
                try {
                    const xml = await fetchComProxy(feed.url);
                    if (!xml) continue;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xml, "text/xml");
                    const items = doc.querySelectorAll("item");
                    
                    for (let i = 0; i < Math.min(items.length, 10); i++) {
                        const item = items[i];
                        const titulo = item.querySelector("title")?.textContent || "";
                        const link = item.querySelector("link")?.textContent || "";
                        const pubDate = item.querySelector("pubDate")?.textContent || "";
                        const imagem = extrairImagem(item);

                        if (titulo && !filtrarPromocao(titulo)) {
                            todasNoticias.push({
                                titulo: titulo,
                                link: link,
                                data: pubDate,
                                imagem: imagem,
                                fonte: feed.nome,
                                cor: feed.cor,
                                timestamp: new Date(pubDate).getTime() || 0
                            });
                        }
                    }
                } catch (e) {}
            }

            // Ordenar por data e pegar as 4 mais recentes
            todasNoticias.sort((a, b) => b.timestamp - a.timestamp);
            const noticiasExibir = todasNoticias.slice(0, 4);

            if (noticiasExibir.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Nenhuma notícia disponível no momento.</p>';
                return;
            }

            // Renderizar usando DOM (evita problemas de aspas)
            container.innerHTML = "";
            
            noticiasExibir.forEach(noticia => {
                const card = document.createElement("div");
                card.className = "noticia-card";

                // Criar imagem ou placeholder
                if (noticia.imagem) {
                    const img = document.createElement("img");
                    img.className = "noticia-imagem";
                    img.src = noticia.imagem;
                    img.alt = "";
                    img.loading = "lazy";
                    img.onerror = function() { handleImageError(this); };
                    card.appendChild(img);
                } else {
                    const placeholder = document.createElement("div");
                    placeholder.className = "noticia-placeholder";
                    placeholder.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>';
                    card.appendChild(placeholder);
                }

                // Conteúdo
                const conteudo = document.createElement("div");
                conteudo.className = "noticia-conteudo";

                const fonte = document.createElement("span");
                fonte.className = "noticia-fonte";
                fonte.style.backgroundColor = noticia.cor;
                fonte.textContent = noticia.fonte;

                const titulo = document.createElement("h3");
                titulo.className = "noticia-titulo";
                const link = document.createElement("a");
                link.href = noticia.link;
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                link.textContent = noticia.titulo;
                titulo.appendChild(link);

                const dataSpan = document.createElement("span");
                dataSpan.className = "noticia-data";
                dataSpan.textContent = formatarData(noticia.data);

                conteudo.appendChild(fonte);
                conteudo.appendChild(titulo);
                conteudo.appendChild(dataSpan);
                card.appendChild(conteudo);
                container.appendChild(card);
            });

            // Atualizar timestamp
            const agora = new Date();
            document.getElementById("ultima-atualizacao").textContent = 
                "Atualizado: " + agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        }

        // Iniciar
        carregarNoticias();
        setInterval(carregarNoticias, 30 * 60 * 1000);
    </script>
</body>
</html>
